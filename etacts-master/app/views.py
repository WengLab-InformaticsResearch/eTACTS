from app import app
from flask import render_template, jsonify, request, session
from lib.extensions import cache
from lib.log import logger
from lib.forms import SearchForm
#from flask_wtf import form
from wtforms import Form
#from flask_wtf import FlaskForm

import lib.oformat as of
import lib.tagcloud as tcloud
import lib.ctgov as ctgov

log = logger ('etacts-view')

'''
make these two variables global
Yingcheng Sun
05/30/2020

Given all tags sorted by their frequency from high to low, top "tagcloud_size + tag_rand" number of tags will be selected at first
and then their order will be randomized. Finally the "tagcloud_size" number of tags will be selected from the randomized tags
See "def random_tags (cloud, ntag, nrand)" in "tagcloud.py"
'''

tagcloud_size=30
tag_rand=0

# home page
@app.route('/etacts')
def index ():
    # get trial number
    nnct = ctgov.get_nct_number ('http://clinicaltrials.gov/search?term=&displayxml=True&count=0')
    # search form    
    form = SearchForm()
    return render_template('index.html', form = form, nnct = of.format_nct_number(nnct))


# about page
@app.route ('/etacts/about')
def about ():
    print 'ciao'
    return render_template('about.html')


# help page
@app.route('/etacts/help')
def help_page():
    return render_template('/help/help.html')

# search definitions page
@app.route('/etacts/definitions')
def definitions_page():
    return render_template('/help/definitions.html')


# tag cloud from regular search
@app.route ('/_tag_cloud')
def tag_cloud ():
    # get parameters
    stxt = request.args.get ('stxt')
    
    '''
    handle the case that use input one quotation mark
    By Yingcheng Sun, 05/23/2020
    '''

    stxt =[i.strip('"') for i in stxt.split(' ')]
    stxt = ' '.join(stxt)

    # save the query in session
    session.clear()
    session['query'] = stxt
    session.modified = True
    # get trials and tags
    rnct = ctgov.get_initial_nct (stxt)


    nct = set ()
    for r in rnct:
        tkn = r.split(';')
        nct.add (tkn[0])
    # get tags for the first cloud
    cloud = tcloud.get_initial_cloud (nct, tagcloud_size, tag_rand)
    log.info ('%s -- first tag cloud' % (request.remote_addr))
    return jsonify (tags = cloud , nct = rnct, q = stxt, n = len(rnct))


# tag cloud from advanced search
@app.route('/_advs_tag_cloud')
def advs_tag_cloud():
    qlabel = request.args.get('qlabel')
    # save the query in session
    session.clear()
    session['query'] = qlabel
    session.modified = True
    # get trials
    url = ctgov.form_advanced_search_url (request.args)

    '''
    temporal method, the API needs to be updated
    Yingcheng Sun
    05/31/2020
    '''
    rnct = ctgov.get_initial_nct_from_url_ad (url)


    nct = set ()
    for r in rnct:
        tkn = r.split(';')
        nct.add (tkn[0])
    # get randomized tags for the cloud
    cloud = tcloud.get_initial_cloud (nct, tagcloud_size, tag_rand)
    log.info ('%s -- first tag cloud' % (request.remote_addr))
    return jsonify (tags = cloud , nct = rnct, q = qlabel, n = len(rnct))


# search for clinical trials
@app.route('/_ctgov_search')
def ctgov_search ():
    stxt = request.args.get ('stxt')
    npag = request.args.get ('npag')

    '''
    handle the case that use input one quotation mark
    By Yingcheng Sun, 05/23/2020
    '''

    stxt =[i.strip('"') for i in stxt.split(' ')]
    stxt = ' '.join(stxt)

    (n, nct) = ctgov.search (stxt, npag)
    if (stxt is None) or (len(stxt) == 0):
        stxt = 'all'
    if npag == '1':
        log.info('%s -- ct.gov-search: q("%s") - res(%s trials)' % (request.remote_addr, stxt, n))
    return jsonify (n=n, nct=nct, q=stxt, npag=npag)


# advanced search for clinical trials
@app.route('/_adv_search')
def ctgov_advanced_search():
    (n, nct) = ctgov.advanced_search(request.args)
    term = request.args.get('term')
    npag = request.args.get('npag')
    fq = of.format_query2print (request.args)
    if npag == '1':
        log.info('%s -- ct.gov-advanced-search: q(%s) - res(%s trials)' % (request.remote_addr, fq, n))
    return jsonify (n=n, nct=nct, q = fq, npag = npag)


# refine search
@app.route ('/_refine_search', methods=['POST'])
def refine_search ():
    tag = list(request.form['tag'].split(';'))

    rnct = of.format_ranked_nct (request.form['nct'])
    npag = int (request.form['npag'])
    tgrp = request.form['ttag']
    trole = request.form['trole']
    

    (snct, unct) = tcloud.get_filtered_result (tag, rnct, npag)
    log.info ('%s -- refine-search: tags(%s) | left(%d trials)' % (request.remote_addr, ';'.join(tag), len(unct)))
    ctag = []
    if len(unct) > 0:
        ctag = tcloud.get_tagcloud (unct, tag, tagcloud_size, tag_rand, tgrp, trole)

    return jsonify (n=of.format_nct_number(len(unct)), npag=npag, tags=ctag, q=session['query'], onct=request.form['nct'], nct=of.format_nct(snct))


# refine search
@app.route ('/_turn_fresult', methods=['POST'])
def turn_fresult ():
    tag = list(request.form['tag'].split(';'))
    rnct = of.format_ranked_nct(request.form['nct'])
    npag = int (request.form['npag'])
    log.info ('%s -- visiting page n. %d' % (request.remote_addr, npag))
    (snct, unct) = tcloud.get_filtered_result (tag, rnct, npag)

    return jsonify (n=of.format_nct_number(len(unct)), npag=npag, onct=request.form['nct'], nct=of.format_nct(snct))


# close the session
@app.route ('/_clean')
def clean ():
    q = session['query']
    session.clear()
    session.modified = True
    log.info ('%s -- tag cloud closed' % request.remote_addr)
    return jsonify (n=0, q=q)


# refine the tag-cloud according to the category
@app.route ('/_refine_tagcloud', methods=['POST'])
def refine_tagcloud():
    tgrp = request.form['ttag']
    tag = list(request.form['tag'].split(';'))
    rnct = of.format_ranked_nct (request.form['nct'])
    nct = tcloud.filter_by_tag (tag, rnct)
    trole = request.form['trole']
    ctag = []
    if len(nct) > 1:
        ctag = tcloud.get_tagcloud (nct, tag, tagcloud_size, tag_rand, tgrp, trole)
    return jsonify (tags=ctag, nct=request.form['nct'], tgrp=tgrp, trole=trole)





